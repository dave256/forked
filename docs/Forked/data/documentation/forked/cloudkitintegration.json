{"schemaVersion":{"major":0,"minor":3,"patch":0},"metadata":{"modules":[{"name":"Forked"}],"title":"CloudKit Integration Guide","role":"article","roleHeading":"Article"},"variants":[{"traits":[{"interfaceLanguage":"swift"}],"paths":["\/documentation\/forked\/cloudkitintegration"]}],"sections":[],"kind":"article","identifier":{"interfaceLanguage":"swift","url":"doc:\/\/Forked\/documentation\/Forked\/CloudKitIntegration"},"seeAlsoSections":[{"anchor":"Articles","title":"Articles","identifiers":["doc:\/\/Forked\/documentation\/Forked\/GettingStarted","doc:\/\/Forked\/documentation\/Forked\/ForkedInnards"],"generated":true}],"abstract":[{"type":"text","text":"Learn how to use ForkedCloudKit to sync your data across devices."}],"primaryContentSections":[{"content":[{"anchor":"Overview","type":"heading","level":2,"text":"Overview"},{"inlineContent":[{"type":"text","text":"ForkedCloudKit makes it easy to sync your Forked data between devices using Apple’s CloudKit framework. This guide will walk you through the basic setup and usage."}],"type":"paragraph"},{"type":"heading","text":"Getting Started","level":2,"anchor":"Getting-Started"},{"inlineContent":[{"text":"First, make sure you have the ForkedCloudKit subpackage added to your project dependencies.","type":"text"}],"type":"paragraph"},{"type":"paragraph","inlineContent":[{"text":"Then import ForkedCloudKit in your source files:","type":"text"}]},{"code":["import Forked","import ForkedCloudKit"],"type":"codeListing","syntax":"swift"},{"level":2,"type":"heading","anchor":"Basic-Setup","text":"Basic Setup"},{"type":"paragraph","inlineContent":[{"type":"text","text":"The main class you’ll work with is "},{"type":"codeVoice","code":"CloudKitExchange"},{"text":". Here’s how to set it up:","type":"text"}]},{"code":["\/\/ Create a ForkedResource for your data","let repo = try AtomicRepository(managedFileURL: fileURL)","let forkedResource = try ForkedResource(repository: repo)","","\/\/ Create CloudKitExchange instance","let cloudKitExchange = try CloudKitExchange(","    id: \"<Unique ID for the repo in CloudKit>\",","    forkedResource: forkedResource,","    unknownModelVersionHandler: { error in","        \/\/ Handle unknown model version by printing the error","        \/\/ In a real app, you might want to show a UI alert telling the user to update","        print(\"Error: \\(error)\")","    }",")"],"syntax":"swift","type":"codeListing"},{"type":"paragraph","inlineContent":[{"type":"text","text":"The "},{"code":"id","type":"codeVoice"},{"text":" parameter should be a unique string that identifies this resource in CloudKit.","type":"text"}]},{"type":"heading","anchor":"How-It-Works","level":2,"text":"How It Works"},{"type":"paragraph","inlineContent":[{"type":"text","text":"CloudKitExchange automatically:"}]},{"items":[{"content":[{"type":"paragraph","inlineContent":[{"text":"Monitors changes to your ForkedResource’s main fork","type":"text"}]}]},{"content":[{"inlineContent":[{"type":"text","text":"Uploads changes to iCloud when detected"}],"type":"paragraph"}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Downloads changes from other devices"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Before merging any changes, it checks the model version of the remote data and the local data. If the model version from iCloud is one that is unknown in the local app, it calls the "},{"type":"codeVoice","code":"unknownModelVersionHandler"},{"type":"text","text":" closure, and stops syncing. The user should update their app to the latest version."}]}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"If the model is known, it merges the remote changes into your local data on the main fork","type":"text"}]}]}],"type":"orderedList"},{"type":"paragraph","inlineContent":[{"type":"text","text":"All of this happens in the background without blocking your app’s UI."}]},{"anchor":"Model-Versioning","type":"heading","text":"Model Versioning","level":2},{"inlineContent":[{"text":"ForkedCloudKit requires your model to conform to ","type":"text"},{"code":"VersionedModel","type":"codeVoice"},{"text":" to ensure safe syncing across different app versions. This is crucial because:","type":"text"}],"type":"paragraph"},{"type":"orderedList","items":[{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Different versions of your app may have different data models"}]}]},{"content":[{"inlineContent":[{"text":"When syncing, you need to ensure the app can understand the data it receives","type":"text"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"type":"text","text":"Older versions of your app should not try to merge data from newer, unknown model versions"}],"type":"paragraph"}]}]},{"type":"paragraph","inlineContent":[{"text":"Here’s how to make your model versioned:","type":"text"}]},{"syntax":"swift","type":"codeListing","code":["@ForkedModel(version: 1)","struct MyData {","    ...","}"]},{"type":"paragraph","inlineContent":[{"type":"text","text":"When you update your model in a new app version, increment the version by 1."}]},{"inlineContent":[{"type":"text","text":"If CloudKitExchange encounters data with an unknown version (higher than the version in the code):"}],"type":"paragraph"},{"type":"orderedList","items":[{"content":[{"inlineContent":[{"text":"It calls your ","type":"text"},{"type":"codeVoice","code":"unknownModelVersionHandler"},{"type":"text","text":" closure"}],"type":"paragraph"}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Stops syncing to prevent data corruption"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"The user should be prompted to update their app"}]}]}]},{"text":"Example Implementation","type":"heading","level":2,"anchor":"Example-Implementation"},{"type":"paragraph","inlineContent":[{"text":"Here’s a complete example showing how to integrate CloudKit sync into a SwiftUI app:","type":"text"}]},{"syntax":"swift","type":"codeListing","code":["@Observable","@MainActor","class Store {","    private let repo: AtomicRepository<MyData>","    private let forkedResource: ForkedResource<AtomicRepository<MyData>>","    private var cloudKitExchange: CloudKitExchange<AtomicRepository<MyData>>!","","    \/\/\/ Set to true when the user needs to upgrade their model","    public var showUpgradeAlert = false","    ","    init() throws {","        \/\/ Setup local storage","        let fileURL = \/\/ ... your file URL","        repo = try AtomicRepository(managedFileURL: fileURL)","        forkedResource = try ForkedResource(repository: repo)","        ","        \/\/ Initialize CloudKit sync","        cloudKitExchange = try CloudKitExchange(","            id: \"<Unique ID for the repo in CloudKit>\",","            forkedResource: forkedResource,","            unknownModelVersionHandler: { [weak self]error in","                self?.showUpgradeAlert = true","            }","        )","    }","}"]},{"type":"heading","text":"CloudKit Setup in Xcode","level":2,"anchor":"CloudKit-Setup-in-Xcode"},{"type":"paragraph","inlineContent":[{"type":"text","text":"Before your app can use CloudKit:"}]},{"type":"orderedList","items":[{"content":[{"inlineContent":[{"text":"Enable iCloud in your Xcode target’s capabilities tab","type":"text"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"type":"text","text":"Choose or add a container ("},{"inlineContent":[{"type":"text","text":"eg"}],"type":"emphasis"},{"type":"text","text":" “iCloud.com.mycompany.myapp”). The container ID should match the "},{"type":"codeVoice","code":"id"},{"text":" parameter in your ","type":"text"},{"code":"CloudKitExchange","type":"codeVoice"},{"text":" initializer.","type":"text"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"text":"Also enable the background modes for remote notifications and background processing","type":"text"}],"type":"paragraph"}]}]},{"text":"Advanced Usage","anchor":"Advanced-Usage","type":"heading","level":2},{"level":3,"text":"Custom Container","type":"heading","anchor":"Custom-Container"},{"type":"paragraph","inlineContent":[{"text":"By default, CloudKitExchange uses the default CloudKit container. You can specify a custom container:","type":"text"}]},{"code":["let container = CKContainer(identifier: \"iCloud.com.mycompany.myapp-another-container\")","let cloudKitExchange = try CloudKitExchange(","    id: \"<Unique ID for the repo in CloudKit>\",","    forkedResource: forkedResource,","    cloudKitContainer: container,","    unknownModelVersionHandler: { error in","        print(\"Error: \\(error)\")","    }",")"],"syntax":"swift","type":"codeListing"},{"text":"Monitoring Sync Updates","type":"heading","level":3,"anchor":"Monitoring-Sync-Updates"},{"inlineContent":[{"type":"text","text":"CloudKitExchange automatically handles sync in the background, but you can monitor when changes from CloudKit are merged into your main fork."}],"type":"paragraph"},{"type":"paragraph","inlineContent":[{"text":"To do this, add a ","type":"text"},{"type":"codeVoice","code":"Task"},{"type":"text","text":" on launch that monitors the "},{"code":"changeStream","type":"codeVoice"},{"type":"text","text":" for changes from CloudKit:"}]},{"code":["Task {","    for await change in forkedResource.changeStream ","        where change.fork == .main && change.mergingFork == .cloudKit {","        \/\/ Handle changes merged from CloudKit into main fork","    }","}"],"syntax":"swift","type":"codeListing"},{"type":"heading","level":2,"text":"Troubleshooting","anchor":"Troubleshooting"},{"type":"paragraph","inlineContent":[{"text":"Common issues and solutions:","type":"text"}]},{"type":"unorderedList","items":[{"content":[{"inlineContent":[{"inlineContent":[{"type":"text","text":"No Sync"}],"type":"strong"},{"type":"text","text":": Ensure iCloud is enabled on the device, the user is signed in, and iCloud Drive enabled"}],"type":"paragraph"}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"strong","inlineContent":[{"text":"Data Not Appearing","type":"text"}]},{"type":"text","text":": Check that your CloudKit container is properly configured."}]}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"strong","inlineContent":[{"text":"No Sync in Production Version","type":"text"}]},{"text":": Make sure you push your CloudKit schema to production before launching your app. Use the CloudKit web portal (https:\/\/icloud.developer.apple.com) to do this","type":"text"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"strong","inlineContent":[{"type":"text","text":"Conflicts"}]},{"text":": ForkedCloudKit automatically handles conflicts using your resource’s merge strategy","type":"text"}]}]}]},{"anchor":"Further-Reading","type":"heading","level":2,"text":"Further Reading"},{"items":[{"content":[{"inlineContent":[{"isActive":true,"identifier":"https:\/\/developer.apple.com\/documentation\/cloudkit","type":"reference"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"type":"reference","identifier":"https:\/\/github.com\/drewmccormack\/Forked","isActive":true}],"type":"paragraph"}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"Sample App: ","type":"text"},{"identifier":"https:\/\/github.com\/drewmccormack\/Forked\/tree\/main\/Samples\/Forking%20Simple%20iCloud","type":"reference","isActive":true}]}]}],"type":"unorderedList"}],"kind":"content"}],"hierarchy":{"paths":[["doc:\/\/Forked\/documentation\/Forked"]]},"references":{"https://github.com/drewmccormack/Forked":{"url":"https:\/\/github.com\/drewmccormack\/Forked","type":"link","titleInlineContent":[{"type":"text","text":"Forked Documentation"}],"identifier":"https:\/\/github.com\/drewmccormack\/Forked","title":"Forked Documentation"},"https://github.com/drewmccormack/Forked/tree/main/Samples/Forking%20Simple%20iCloud":{"url":"https:\/\/github.com\/drewmccormack\/Forked\/tree\/main\/Samples\/Forking%20Simple%20iCloud","type":"link","titleInlineContent":[{"text":"Forking Simple iCloud","type":"text"}],"identifier":"https:\/\/github.com\/drewmccormack\/Forked\/tree\/main\/Samples\/Forking%20Simple%20iCloud","title":"Forking Simple iCloud"},"https://developer.apple.com/documentation/cloudkit":{"url":"https:\/\/developer.apple.com\/documentation\/cloudkit","type":"link","titleInlineContent":[{"type":"text","text":"CloudKit Documentation"}],"identifier":"https:\/\/developer.apple.com\/documentation\/cloudkit","title":"CloudKit Documentation"},"doc://Forked/documentation/Forked/GettingStarted":{"identifier":"doc:\/\/Forked\/documentation\/Forked\/GettingStarted","type":"topic","kind":"article","abstract":[{"type":"text","text":"Learn how to use Forked to manage shared data in your Swift applications."}],"title":"Getting Started with Forked","role":"article","url":"\/documentation\/forked\/gettingstarted"},"doc://Forked/documentation/Forked/ForkedInnards":{"role":"article","abstract":[{"type":"text","text":"Forked is built around a simple yet powerful concept: data conflicts should be treated as a natural part of software systems rather than an exceptional state."}],"kind":"article","url":"\/documentation\/forked\/forkedinnards","identifier":"doc:\/\/Forked\/documentation\/Forked\/ForkedInnards","type":"topic","title":"Forked Innards: Understanding the Architecture"},"doc://Forked/documentation/Forked":{"title":"Forked","type":"topic","kind":"symbol","url":"\/documentation\/forked","abstract":[{"type":"text","text":"A framework for handling shared data with confidence in Swift."}],"role":"collection","identifier":"doc:\/\/Forked\/documentation\/Forked"}}}